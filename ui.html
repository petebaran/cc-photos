<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Capital Assets</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { 
      --bg:#0c0c0f; --panel:#111216; --line:#1e1f26; --fg:#f2f2f3; --muted:#a1a1aa; 
      --brand:#c08415; --error:#ff6b6b; --success:#4ade80; --overlay:rgba(0,0,0,0.6);
    }
    * { box-sizing: border-box; }
    body { margin:0; font:12px/1.4 Inter, ui-sans-serif, system-ui; color:var(--fg); background:var(--bg); }
    
    /* Header */
    header { padding:12px; background:var(--panel); border-bottom:1px solid var(--line); }
    .row { display:flex; gap:12px; align-items:center; }
    label { color:var(--muted); font-weight:500; }
    select, input[type="checkbox"] { background:#13141a; border:1px solid var(--line); color:var(--fg); border-radius:6px; }
    select { padding:8px; }
    input[type="checkbox"] { width:18px; height:18px; accent-color:var(--brand); }
    select:focus, input:focus { outline:none; border-color:var(--brand); }
    button { background:#1a1b22; border:1px solid var(--line); color:var(--fg); border-radius:8px; padding:8px 12px; cursor:pointer; transition:all 0.2s; }
    button:hover:not(:disabled) { background:#252631; }
    button.primary { background:var(--brand); border-color:var(--brand); color:#fff; font-weight:600; }
    button.primary:hover:not(:disabled) { background:#9b6b0b; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    
    #status { color:var(--muted); margin-top:6px; display:block; font-size:11px; }
    #status.error { color:var(--error); }
    #status.success { color:var(--success); }

    /* Character info box */
    #character-info {
      display: none;
      padding: 12px;
      background: var(--panel);
      border-bottom: 1px solid var(--line);
    }
    #character-info.visible { display: block; }
    .char-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    .char-name {
      font-weight: 600;
      font-size: 13px;
      color: var(--fg);
    }
    .char-role {
      color: var(--brand);
      font-size: 11px;
      font-weight: 500;
    }
    .char-age {
      color: var(--muted);
      font-size: 11px;
      background: #1a1b22;
      padding: 2px 6px;
      border-radius: 4px;
    }
    .char-description {
      color: var(--muted);
      font-size: 11px;
      line-height: 1.5;
    }

    /* Pinterest-style masonry grid with proper scrolling */
    #grid {
      height: 420px; 
      overflow-y: scroll; 
      overflow-x: hidden; 
      padding: 12px;
      position: relative;
    }
    
    .masonry-container {
      position: relative;
      width: 100%;
    }
    
    /* Dark scrollbar */
    #grid::-webkit-scrollbar { width: 8px; }
    #grid::-webkit-scrollbar-track { background: #111216; }
    #grid::-webkit-scrollbar-thumb { background: #2a2a2a; border-radius: 4px; }
    #grid::-webkit-scrollbar-thumb:hover { background: #3a3a3a; }
    
    .card { 
      position: absolute; 
      border-radius: 12px; 
      overflow: hidden; 
      background: #0e0f14; 
      cursor: pointer; 
      transition: all 0.2s ease;
      border: 2px solid transparent;
    }
    
    .card:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(0,0,0,0.3); }
    .card.sel { border-color: var(--brand); box-shadow: 0 0 0 3px rgba(24,160,251,0.2); }
    .card.loading { opacity: 0.7; }
    .card.error { border-color: var(--error); opacity: 0.6; }
    
    .card img { 
      width: 100%; 
      height: auto; 
      display: block; 
      transition: opacity 0.3s ease;
      border-radius: 8px;
    }
    .card.loading img { opacity: 0.5; }
    
    .card-overlay { 
      position: absolute; 
      inset: 0; 
      background: var(--overlay); 
      opacity: 0; 
      transition: opacity 0.2s ease;
      display: flex; 
      align-items: center; 
      justify-content: center;
    }
    .card:hover .card-overlay { opacity: 1; }
    .card.sel .card-overlay { opacity: 1; }
    
    .check { 
      width: 24px; 
      height: 24px; 
      background: var(--brand); 
      border-radius: 6px; 
      display: flex; 
      align-items: center; 
      justify-content: center;
      color: #fff; 
      font-size: 14px; 
      font-weight: bold;
      transition: all 0.2s ease; 
      transform: scale(0.8);
    }
    .card.sel .check { transform: scale(1); }
    
    .loading-placeholder {
      width: 100%; 
      aspect-ratio: 1; /* Square placeholder until we know the real image size */
      background: linear-gradient(90deg, #1a1b22 25%, #252631 50%, #1a1b22 75%);
      background-size: 200% 100%; 
      animation: shimmer 2s infinite;
      border-radius: 8px;
    }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    
    .error-text { 
      position: absolute; 
      inset: 0; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      background: rgba(255,107,107,0.1); 
      color: var(--error); 
      font-size: 10px; 
      text-align: center; 
      padding: 8px;
      border-radius: 8px;
    }
    
    .image-info {
      position: absolute; 
      bottom: 8px; 
      left: 8px; 
      right: 8px;
      background: rgba(0,0,0,0.7); 
      padding: 4px 8px; 
      border-radius: 6px;
      font-size: 10px; 
      color: #fff; 
      opacity: 0; 
      transition: opacity 0.2s;
      backdrop-filter: blur(4px);
    }
    .card:hover .image-info { opacity: 1; }

    /* Footer */
    footer { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      gap: 8px; 
      padding: 12px; 
      border-top: 1px solid var(--line); 
      background: var(--panel); 
    }
    .meta { color: var(--muted); font-size: 11px; }
    .actions { display: flex; gap: 8px; }

    /* Empty state */
    .empty-state { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      justify-content: center; 
      height: 300px; 
      color: var(--muted); 
      text-align: center; 
    }
    .empty-state h3 { margin: 0 0 8px 0; font-size: 14px; font-weight: 600; }
    .empty-state p { margin: 0; font-size: 12px; opacity: 0.8; }
    
    /* Loading states */
    .grid-loading { 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      height: 200px; 
      color: var(--muted); 
    }
    .spinner { 
      width: 20px; 
      height: 20px; 
      border: 2px solid var(--line); 
      border-top: 2px solid var(--brand); 
      border-radius: 50%; 
      animation: spin 1s linear infinite; 
      margin-right: 8px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .selection-badge {
      background: var(--brand); 
      color: #fff; 
      font-size: 10px; 
      font-weight: 600;
      padding: 2px 6px; 
      border-radius: 10px; 
      margin-left: 4px;
    }
  </style>
</head>
<body>
  <header>
    <div class="row">
      <label>Folder</label>
      <select id="category"></select>
      <label>Sort</label>
      <select id="sortOrder">
        <option value="default">Default</option>
        <option value="recent">Recent</option>
        <option value="oldest">Oldest</option>
      </select>
      <button id="refresh">Refresh</button>
    </div>
    <small id="status">Ready to browse photos</small>
  </header>

  <div id="character-info">
    <div class="char-header">
      <span class="char-name" id="char-name"></span>
      <span class="char-role" id="char-role"></span>
      <span class="char-age" id="char-age"></span>
    </div>
    <div class="char-description" id="char-description"></div>
  </div>

  <div id="grid"></div>

  <footer>
    <div class="meta">
      <span id="count">0 selected</span>
      <span id="total-info"></span>
    </div>
    <div class="actions">
      <button id="selectAll">Select all</button>
      <button id="clearSel">Clear</button>
      <button id="place" class="primary" disabled>Place selected</button>
    </div>
  </footer>

  <script>
    // Configuration
    var CDN_BASE = "https://d3a10mptdebtwd.cloudfront.net/";
    var FOLDERS = ["Amir", "Carmen", "David", "Diego", "Elena", "Hiroshi", "Isabella", "Jake", "James", "Khalid", "Layla", "Li-Chen", "Marcus", "Mei-Lin", "Mike", "Monica", "Omar", "Rafael", "Sarah", "Sophia", "Wei-Ming"];
    function INDEX_URL(name){ return CDN_BASE + name + ".index.json"; }

    // Character descriptions data
    var CHARACTER_DATA = {
      "Amir": { role: "Associate", age: 29, description: "Middle Eastern male with olive skin, contemporary style. Smart casual startup-to-corporate crossover. Best for: tech-forward content, growth narratives, fintech positioning." },
      "Carmen": { role: "Strategic Advisor", age: 39, description: "Colombian female with warm skin, soft natural waves. Architectural black suits with Colombian elegance. Best for: Colombian market, LATAM strategic positioning." },
      "David": { role: "Strategic Director", age: 47, description: "Singaporean male with multicultural features, silver-threaded hair. International business styling. Best for: Singapore market, global financial messaging, cross-cultural appeal." },
      "Diego": { role: "Dynamic Strategist", age: 41, description: "Latino male with Mexican heritage, bronze skin, silver-threaded hair. Contemporary Latin tailoring. Best for: LATAM leadership, dynamic energy, market movement." },
      "Elena": { role: "Creative Visionary", age: 27, description: "Latina female with soft red-blonde curls, hazel-green eyes. Bohemian luxury with structured elements. Best for: creative interpretations, artistic-financial bridge." },
      "Hiroshi": { role: "Innovation Strategist", age: 49, description: "Japanese male with angular features, salt-and-pepper hair, premium eyewear. Minimalist precision tailoring. Best for: innovation, Asian markets, tech-forward narratives." },
      "Isabella": { role: "Strategic Executive", age: 41, description: "Mexican female with warm brown skin, wavy dark hair. Sharp black power suits with bronze amber silk. Best for: LATAM executive positioning, cultural bridge building." },
      "Jake": { role: "Tech Trader", age: 31, description: "Caucasian male with sandy blonde hair, groomed mustache, blue-gray eyes. Smart-casual premium blazer style. Best for: tech/crypto content, Scandinavian appeal, millennial-Gen Z bridge." },
      "James": { role: "Strategic Authority", age: 47, description: "Black male with strong features, silver-touched temples. Architectural charcoal suits. Best for: executive authority, corporate leadership, international business." },
      "Khalid": { role: "Regional Director", age: 43, description: "Lebanese male with olive skin, silver-threaded beard. Contemporary Middle Eastern executive style. Best for: Lebanese market, Middle Eastern expansion, Mediterranean appeal." },
      "Layla": { role: "Executive Director", age: 42, description: "Lebanese-Emirati female with golden olive skin, natural waves. Modern modest luxury with cultural elements. Best for: UAE Lebanese community, Middle Eastern female representation." },
      "Li-Chen": { role: "Investment Executive", age: 42, description: "Hong Kong female with refined features, sleek professional styling. Sharp power suits with Asian precision. Best for: Hong Kong market, East-West bridge, financial authority." },
      "Marcus": { role: "Distinguished Mentor", age: 54, description: "Caucasian executive with salt-and-pepper hair, cerulean blue eyes. Tom Ford suits, commanding 6'1\" presence. Best for: luxury positioning, mentorship narratives, UAE market." },
      "Mei-Lin": { role: "Innovation Analyst", age: 27, description: "Taiwanese female with sleek dark hair, bright intelligent eyes. Taipei creative contemporary style. Best for: Taiwan innovation, tech-finance, creative market approaches." },
      "Mike": { role: "Regional Manager", age: 42, description: "Caucasian male with receding hairline, practical eyeglasses, dad-body build. Accessible casual professional. Best for: middle-class trust-building, realistic success, work-life balance." },
      "Monica": { role: "Analyst", age: 31, description: "Black woman with Afro-Caribbean heritage, natural protective hairstyles, authentic features. Casual professional basics. Best for: trust-building, authentic relatability, real workplace energy." },
      "Omar": { role: "Strategic Advisor", age: 45, description: "Emirati male with olive skin, silver-threaded beard. Modern kandora with cultural accents. Best for: UAE resonance, heritage-meets-innovation, strategic wisdom." },
      "Rafael": { role: "Investment Strategist", age: 46, description: "Brazilian male with bronze skin, salt-and-pepper styling. Premium São Paulo tailoring. Best for: Brazilian market leadership, LATAM expansion, executive sophistication." },
      "Sarah": { role: "Authentic Professional", age: 49, description: "Mixed heritage female with natural silver strands, lived-in elegance. Sophisticated but approachable wear. Best for: trust-building, relatability, everyday trader appeal." },
      "Sophia": { role: "Cultural Connector", age: 26, description: "Mixed Asian-European female with modern styling. Global contemporary with cultural fusion. Best for: global market appeal, cultural connectivity, international positioning." },
      "Wei-Ming": { role: "Financial Strategist", age: 44, description: "Taiwanese male with angular features, silver-threaded temples, contemporary eyewear. Minimalist luxury. Best for: Taiwan market, precision messaging, tech-finance." },
      "Kenji": { role: "Innovative Thinker", age: 29, description: "Japanese-American male with clean modern aesthetic, angular features. Architectural minimalist clothing. Best for: tech content, innovation messaging, future-forward positioning." },
      "Sofia": { role: "Latina Creative Professional", age: 28, description: "Latina female with espresso hair, warm amber eyes. Avant-garde silhouettes with architectural blazers. Best for: trend identification, creative approaches, younger demographics." }
    };

    function updateCharacterInfo(folderName) {
      var infoBox = $("character-info");
      var char = CHARACTER_DATA[folderName];

      if (char && folderName !== "All") {
        $("char-name").textContent = folderName;
        $("char-role").textContent = char.role;
        $("char-age").textContent = "Age " + char.age;
        $("char-description").textContent = char.description;
        infoBox.classList.add("visible");
      } else {
        infoBox.classList.remove("visible");
      }
    }

    // State
    var catalog = new Map();
    var selected = new Set();
    var current = "All";
    var isLoading = false;

    // Helpers
    function $(id){ return document.getElementById(id); }
    function status(text, type){ 
      var el = $("status");
      el.textContent = text;
      el.className = type || "";
      console.log("[STATUS]", text);
    }
    function post(msg){ 
      console.log("[SEND]", msg);
      parent.postMessage({ pluginMessage: msg }, "*"); 
    }
    function setSelectedCount(n){ 
      var countEl = $("count");
      countEl.innerHTML = n + " selected" + (n > 0 ? '<span class="selection-badge">' + n + '</span>' : '');
      $("place").disabled = n === 0; 
    }
    function updateTotalInfo(shown, total) {
      $("total-info").textContent = "";
    }

    // Initialize
    init();

    function init(){
      console.log("[INIT] Starting Capital Assets");
      populateCategorySelect();
      
      status("Loading photo catalog...");
      refreshCatalog(true)
        .then(function(){
          renderGrid();
          status("Ready to browse photos");
        })
        .catch(function(err){
          status("Failed to load catalog: " + err.message, "error");
        });
        
      wireUI();
    }

    function wireUI(){
      $("refresh").onclick = function(){ 
        if (isLoading) return;
        status("Refreshing catalog...");
        refreshCatalog(true)
          .then(function(){
            renderGrid();
            status("Catalog refreshed");
          })
          .catch(function(err){
            status("Refresh failed: " + err.message, "error");
          });
      };
      
      $("category").onchange = function(){
        current = $("category").value;
        updateCharacterInfo(current);
        renderGrid();
      };
      
      $("sortOrder").onchange = function(){
        renderGrid();
      };
      
      $("selectAll").onclick = function(){
        var cards = document.querySelectorAll(".card:not(.error):not(.loading)");
        var newSelections = 0;
        
        for (var i = 0; i < cards.length; i++) {
          var card = cards[i];
          if (!card.classList.contains("sel")) {
            selectCard(card, card.dataset.url);
            newSelections++;
          }
        }
        
        status("Selected " + newSelections + " additional images");
      };
      
      $("clearSel").onclick = function(){
        clearSelection();
        status("Selection cleared");
      };
      
      $("place").onclick = function(){
        var urls = Array.from(selected);
        
        if (!urls.length) {
          status("No images selected", "error");
          return;
        }
        
        $("place").disabled = true;
        status("Processing " + urls.length + " image(s) at original size...");
        
        post({ 
          type: "place-images", 
          urls: urls, 
          useOriginalSize: true
        });
      };
      
      // Message handler
      window.onmessage = function(e){
        var msg = e.data.pluginMessage; 
        if (!msg) return;
        
        if (msg.type === "progress") {
          if (msg.stage === "received") {
            status("Processing " + msg.total + " image(s)...");
          } else if (msg.stage === "download") {
            var current = msg.currentFile ? " (" + msg.currentFile + ")" : "";
            status("Processing " + (msg.done + 1) + "/" + msg.total + current);
          }
        } else if (msg.type === "placed") {
          status("Successfully placed " + msg.count + " image(s)", "success");
          $("place").disabled = false;
          
          // Auto-clear after success
          setTimeout(function(){
            clearSelection();
          }, 2000);
          
        } else if (msg.type === "error") {
          status("Error: " + msg.message, "error");
          $("place").disabled = false;
        }
      };
      
      // Handle window resize for responsive masonry
      var resizeTimer;
      window.onresize = function() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(function() {
          var newColumnCount = getColumnCount();
          if (newColumnCount !== columnCount) {
            renderGrid(); // Re-render with new column count
          }
        }, 250);
      };
    }

    function populateCategorySelect(){
      var select = $("category");
      select.innerHTML = "";
      select.appendChild(new Option("All photos", "All"));
      
      for (var i = 0; i < FOLDERS.length; i++) {
        select.appendChild(new Option(FOLDERS[i], FOLDERS[i]));
      }
      
      select.value = "All";
    }

    function updateCountsInDropdown(){
      var select = $("category");
      
      for (var i = 0; i < select.options.length; i++){
        var option = select.options[i];
        
        if (option.value === "All"){
          var total = 0; 
          catalog.forEach(function(entry){ total += entry.files.length; });
          option.textContent = "All photos (" + total + ")";
        } else {
          var entry = catalog.get(option.value);
          var count = entry ? entry.files.length : 0;
          option.textContent = option.value + " (" + count + ")";
        }
      }
    }

    function refreshCatalog(force){
      isLoading = true;
      
      var promises = FOLDERS.map(function(folderName){
        if (!force && catalog.has(folderName)) {
          return Promise.resolve();
        }
        
        return fetch(INDEX_URL(folderName))
          .then(function(response){ 
            if (!response.ok) throw new Error("HTTP " + response.status + " for " + folderName); 
            return response.text(); 
          })
          .then(function(text){
            var cleanText = text.replace(/^\uFEFF/, '');
            var index = JSON.parse(cleanText);
            
            var prefix = (index.prefix || folderName + "/").replace(/^\//, "").replace(/\/?$/, "/");
            var files = Array.isArray(index.files) ? 
              index.files.filter(function(filename){ 
                return /\.(png|jpe?g|webp|avif)$/i.test(filename); 
              }) : [];
            
            catalog.set(folderName, { prefix: prefix, files: files });
          })
          .catch(function(error){
            console.error("[CATALOG] Failed:", folderName, error);
            catalog.set(folderName, { prefix: folderName + "/", files: [] });
          });
      });
      
      return Promise.all(promises)
        .then(function(){ 
          updateCountsInDropdown();
          isLoading = false;
        });
    }

    function buildUrlsForCategory(categoryName){
      var urls;
      
      if (categoryName === "All"){
        var allUrls = [];
        catalog.forEach(function(entry){ 
          var folderUrls = entry.files.map(function(filename){ 
            return CDN_BASE + entry.prefix + filename; 
          });
          allUrls = allUrls.concat(folderUrls);
        });
        urls = allUrls;
      } else {
        var entry = catalog.get(categoryName);
        if (!entry) return [];
        
        urls = entry.files.map(function(filename){ 
          return CDN_BASE + entry.prefix + filename; 
        });
      }
      
      // Apply sorting
      return sortUrls(urls);
    }
    
    function sortUrls(urls) {
      var sortOrder = $("sortOrder").value;
      
      if (sortOrder === "default") {
        return urls;
      }
      
      // Create array of objects with url and extracted sort key
      var urlsWithKeys = urls.map(function(url) {
        var filename = url.split("/").pop().toLowerCase();
        var sortKey = extractSortKey(filename);
        return { url: url, sortKey: sortKey, filename: filename };
      });
      
      // Sort based on sort key
      urlsWithKeys.sort(function(a, b) {
        if (sortOrder === "recent") {
          return b.sortKey - a.sortKey; // Descending (recent first)
        } else if (sortOrder === "oldest") {
          return a.sortKey - b.sortKey; // Ascending (oldest first)
        }
        return 0;
      });
      
      // Return just the URLs
      return urlsWithKeys.map(function(item) { return item.url; });
    }
    
    function extractSortKey(filename) {
      // Try to extract a timestamp or number from filename for sorting
      // Common patterns: IMG_20231201_123456.jpg, photo_1701234567.jpg, 001.jpg, etc.
      
      // Look for timestamp patterns (YYYYMMDD, YYYYMMDD_HHMMSS, unix timestamp)
      var timestampMatch = filename.match(/(\d{8}_\d{6}|\d{8}|\d{10,13})/);
      if (timestampMatch) {
        var timestamp = timestampMatch[1];
        if (timestamp.length === 8) {
          // YYYYMMDD format
          return parseInt(timestamp);
        } else if (timestamp.length === 15) {
          // YYYYMMDD_HHMMSS format
          return parseInt(timestamp.replace('_', ''));
        } else if (timestamp.length >= 10) {
          // Unix timestamp
          return parseInt(timestamp);
        }
      }
      
      // Look for sequential numbers
      var numberMatch = filename.match(/(\d+)/);
      if (numberMatch) {
        return parseInt(numberMatch[1]);
      }
      
      // Fall back to filename alphabetical ordering
      return filename.charCodeAt(0) * 1000 + (filename.charCodeAt(1) || 0);
    }

    // Masonry layout variables
    var masonryColumns = [];
    var columnWidth = 0;
    var columnCount = 3;
    
    function getColumnCount() {
      var gridWidth = $("grid").offsetWidth - 24; // Account for padding
      if (gridWidth < 350) return 1;
      if (gridWidth < 450) return 2;
      if (gridWidth < 600) return 3;
      if (gridWidth < 750) return 4;
      return 5;
    }
    
    function initMasonry() {
      var grid = $("grid");
      columnCount = getColumnCount();
      columnWidth = Math.floor((grid.offsetWidth - 24 - (columnCount - 1) * 12) / columnCount);
      
      masonryColumns = [];
      for (var i = 0; i < columnCount; i++) {
        masonryColumns[i] = 0; // Track height of each column
      }
    }
    
    function getShortestColumn() {
      var shortest = 0;
      for (var i = 1; i < masonryColumns.length; i++) {
        if (masonryColumns[i] < masonryColumns[shortest]) {
          shortest = i;
        }
      }
      return shortest;
    }
    
    function renderGrid(){
      var grid = $("grid");
      grid.innerHTML = "";
      clearSelection();
      
      // Reset pending images array
      pendingImages = [];
      
      if (isLoading) {
        grid.innerHTML = '<div class="grid-loading"><div class="spinner"></div>Loading photos...</div>';
        return;
      }
      
      var urls = buildUrlsForCategory(current);
      
      if (urls.length === 0) {
        grid.innerHTML = '<div class="empty-state"><h3>No photos found</h3><p>Try refreshing or selecting a different folder.</p></div>';
        updateTotalInfo(0, 0);
        return;
      }
      
      updateTotalInfo(urls.length, urls.length);
      
      // Create masonry container
      var container = document.createElement("div");
      container.className = "masonry-container";
      grid.appendChild(container);
      
      // Initialize masonry layout
      initMasonry();
      
      // Add cards with masonry positioning
      for (var i = 0; i < urls.length; i++) {
        createImageCard(urls[i], container);
      }
    }
    
    // Remove ensureScrollable function - masonry layout handles this naturally

    var pendingImages = [];
    
    function createImageCard(url, container){
      var filename = url.split("/").pop();
      
      var card = document.createElement("div");
      card.className = "card loading";
      card.dataset.url = url;
      card.style.width = columnWidth + "px";
      
      // Placeholder while loading
      var placeholder = document.createElement("div");
      placeholder.className = "loading-placeholder";
      card.appendChild(placeholder);
      
      var img = document.createElement("img");
      img.loading = "lazy";
      img.alt = filename;
      
      var overlay = document.createElement("div");
      overlay.className = "card-overlay";
      
      var check = document.createElement("div");
      check.className = "check";
      check.innerHTML = "✓";
      overlay.appendChild(check);
      
      var info = document.createElement("div");
      info.className = "image-info";
      info.textContent = filename;

      card.appendChild(img);
      card.appendChild(overlay);
      card.appendChild(info);
      
      // Store for positioning after load
      pendingImages.push({
        card: card,
        img: img,
        placeholder: placeholder,
        url: url,
        loaded: false
      });
      
      // Image loading
      img.onload = function(){
        card.classList.remove("loading");
        placeholder.style.display = "none";
        img.style.opacity = "1";
        
        // Mark as loaded and reposition all images
        for (var i = 0; i < pendingImages.length; i++) {
          if (pendingImages[i].img === img) {
            pendingImages[i].loaded = true;
            break;
          }
        }
        
        repositionMasonry();
      };
      
      img.onerror = function(){
        card.classList.remove("loading");
        card.classList.add("error");
        placeholder.innerHTML = '<div class="error-text">Failed to load</div>';
        
        // Mark as loaded (even if error) and reposition
        for (var i = 0; i < pendingImages.length; i++) {
          if (pendingImages[i].img === img) {
            pendingImages[i].loaded = true;
            break;
          }
        }
        
        repositionMasonry();
      };
      
      // Click handler
      card.onclick = function(){
        if (card.classList.contains("error") || card.classList.contains("loading")) {
          return;
        }
        
        if (card.classList.contains("sel")) {
          deselectCard(card, url);
        } else {
          selectCard(card, url);
        }
      };
      
      // Set source after handlers
      img.src = url;
      container.appendChild(card);
    }
    
    function repositionMasonry() {
      // Reset column heights
      for (var i = 0; i < masonryColumns.length; i++) {
        masonryColumns[i] = 0;
      }
      
      // Position all loaded images
      for (var i = 0; i < pendingImages.length; i++) {
        var item = pendingImages[i];
        if (item.loaded) {
          var columnIndex = getShortestColumn();
          var x = columnIndex * (columnWidth + 12);
          var y = masonryColumns[columnIndex];
          
          item.card.style.left = x + "px";
          item.card.style.top = y + "px";
          
          // Add actual card height to column
          var cardHeight = item.card.offsetHeight;
          masonryColumns[columnIndex] += cardHeight + 12;
        }
      }
      
      // Update container height
      var container = document.querySelector(".masonry-container");
      if (container) {
        var maxHeight = Math.max.apply(Math, masonryColumns);
        container.style.height = maxHeight + "px";
      }
    }

    function selectCard(card, url) {
      card.classList.add("sel");
      selected.add(url);
      setSelectedCount(selected.size);
    }

    function deselectCard(card, url) {
      card.classList.remove("sel");
      selected.delete(url);
      setSelectedCount(selected.size);
    }

    function clearSelection() {
      selected.clear();
      var selectedCards = document.querySelectorAll(".card.sel");
      for (var i = 0; i < selectedCards.length; i++) {
        selectedCards[i].classList.remove("sel");
      }
      setSelectedCount(0);
    }
  </script>
</body>
</html>